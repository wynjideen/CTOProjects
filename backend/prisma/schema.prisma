// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  studyMaterials StudyMaterial[]
  learningPaths  LearningPath[]
  progress       UserProgress[]

  @@map("users")
}

model Course {
  id          String   @id @default(cuid())
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  studyMaterials StudyMaterial[]
  learningPaths  LearningPath[]

  @@map("courses")
}

model StudyMaterial {
  id              String   @id @default(cuid())
  filename        String
  originalName    String
  contentType     String
  sizeBytes       BigInt
  s3Key           String   @unique
  s3Bucket        String
  s3Version       String?
  uploadStatus    UploadStatus @default(PENDING_VALIDATION)
  processingStatus ProcessingStatus @default(PENDING)
  
  // Metadata
  userId          String
  courseId        String?
  documentType    String?
  tags            String[]
  description     String?
  
  // Processing metrics
  pagesExtracted   Int?
  chunksCreated    Int?
  processingTimeMs Int?
  errorDetails     String?
  
  // Job references
  uploadJobId      String?
  processingJobId  String?
  deletionJobId    String?
  
  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  processedAt      DateTime?
  
  // Relations
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  course           Course?    @relation(fields: [courseId], references: [id], onDelete: SetNull)
  contentChunks    ContentChunk[]
  
  @@map("study_materials")
}

model ContentChunk {
  id          String   @id @default(cuid())
  fileId      String
  sectionId   String?
  content     String
  contentType String
  order       Int
  
  // Metadata
  language           String?
  complexityScore    Float?
  estimatedReadingTimeSeconds Int?
  
  // Embedding
  embeddingModel     String?
  embeddingVector    Float[]
  embeddingGeneratedAt DateTime?
  
  // Relations
  studyMaterial StudyMaterial @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  @@map("content_chunks")
}

model LearningPath {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      LearningPathStatus @default(ACTIVE)
  
  userId      String
  courseId    String?
  
  // Learning objectives and preferences
  learningObjectives String[]
  userKnowledgeLevel String?
  learningStyle      String?
  pacePreference     String?
  
  // Timing
  estimatedCompletionTimeDays Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course?   @relation(fields: [courseId], references: [id], onDelete: SetNull)
  lessons Lesson[]
  
  @@map("learning_paths")
}

model Lesson {
  id          String   @id @default(cuid())
  pathId      String
  title       String
  order       Int
  description String?
  
  // Learning objectives
  learningObjectives String[]
  estimatedDurationMinutes Int?
  
  // Status and progress
  status      LessonStatus @default(PENDING)
  
  // Relations
  learningPath LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  contentSources LessonContentSource[]
  assessment   Assessment?
  userProgress UserProgress[]
  
  @@map("lessons")
}

model LessonContentSource {
  id       String @id @default(cuid())
  lessonId String
  chunkId  String
  fileId   String
  title    String
  type     String // reading|video|interactive|exercise
  
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@map("lesson_content_sources")
}

model Assessment {
  id        String   @id @default(cuid())
  lessonId  String   @unique
  type      String   // quiz|exercise|project
  required  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  lesson    Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@map("assessments")
}

model UserProgress {
  id          String   @id @default(cuid())
  userId      String
  lessonId    String
  pathId      String
  
  status      ProgressStatus @default(NOT_STARTED)
  startedAt   DateTime?
  completedAt DateTime?
  completionPercentage Float @default(0)
  score       Float?
  timeSpentSeconds Int?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user        User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson      Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  @@unique([userId, lessonId])
  @@map("user_progress")
}

model Job {
  id          String   @id @default(cuid())
  type        JobType
  status      JobStatus @default(PENDING)
  priority    Int @default(0)
  
  // Job data
  payload     Json?
  result      Json?
  error       String?
  
  // Timing
  scheduledAt DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  retryCount  Int @default(0)
  maxRetries  Int @default(3)
  
  @@map("jobs")
}

enum UploadStatus {
  PENDING_VALIDATION
  UPLOADING
  UPLOADED
  VALIDATION_FAILED
  DELETION_SCHEDULED
  DELETED
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  READY
  PARTIAL
  FAILED
}

enum LearningPathStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum LessonStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum JobType {
  CONTENT_PROCESSING
  LESSON_GENERATION
  EMBEDDING_GENERATION
  VIRUS_SCAN
  FILE_DELETION
  PROGRESS_SNAPSHOT
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}
